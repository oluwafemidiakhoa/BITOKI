{% extends "base.html" %}

{% block title %}KYC Verification - BITOKI{% endblock %}

{% block extra_css %}
<style>
    .kyc-level-card {
        border: 2px solid #e0e0e0;
        transition: all 0.3s;
    }
    .kyc-level-card.active {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    .kyc-level-card.completed {
        border-color: #198754;
        background-color: #d1e7dd;
    }
    .level-badge {
        font-size: 2rem;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin: 0 auto 15px;
    }
    .upload-area {
        border: 2px dashed #0d6efd;
        border-radius: 10px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-area:hover {
        background-color: #f8f9fa;
        border-color: #0a58ca;
    }
    .document-preview {
        max-width: 200px;
        border-radius: 8px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4"><i class="fas fa-id-card"></i> KYC Verification</h2>

    <!-- Current Status Alert -->
    <div class="alert alert-info mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="alert-heading mb-2">
                    <i class="fas fa-info-circle"></i> Current KYC Level:
                    <span class="badge bg-primary">Level {{ current_user.kyc_level }}</span>
                </h5>
                <p class="mb-0">
                    {% if current_user.kyc_level == 0 %}
                        <strong>Daily Limit:</strong> $500 | <strong>Withdrawals:</strong> Disabled
                    {% elif current_user.kyc_level == 1 %}
                        <strong>Daily Limit:</strong> $2,000 | <strong>Withdrawals:</strong> $500/day
                    {% elif current_user.kyc_level == 2 %}
                        <strong>Daily Limit:</strong> $10,000 | <strong>Withdrawals:</strong> $3,000/day
                    {% else %}
                        <strong>Daily Limit:</strong> $50,000 | <strong>Withdrawals:</strong> $10,000/day
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-end">
                {% if current_user.kyc_status == 'pending' %}
                    <span class="badge bg-warning fs-6"><i class="fas fa-clock"></i> Pending Review</span>
                {% elif current_user.kyc_status == 'approved' %}
                    <span class="badge bg-success fs-6"><i class="fas fa-check-circle"></i> Verified</span>
                {% elif current_user.kyc_status == 'rejected' %}
                    <span class="badge bg-danger fs-6"><i class="fas fa-times-circle"></i> Rejected</span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Why KYC? -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-question-circle"></i> Why Do We Need KYC?</h5>
        </div>
        <div class="card-body">
            <p>KYC (Know Your Customer) verification helps us:</p>
            <ul class="mb-0">
                <li><strong>Protect your account</strong> from fraud and unauthorized access</li>
                <li><strong>Comply with regulations</strong> for cryptocurrency trading in Nigeria</li>
                <li><strong>Increase your limits</strong> for higher trading volumes</li>
                <li><strong>Enable withdrawals</strong> to external wallets and bank accounts</li>
            </ul>
            <p class="mt-3 mb-0"><small class="text-muted">
                <i class="fas fa-lock"></i> Your data is encrypted and stored securely. We never share your information without your consent.
            </small></p>
        </div>
    </div>

    <!-- KYC Levels -->
    <div class="row mb-4">
        <!-- Level 0 -->
        <div class="col-md-3 mb-3">
            <div class="card kyc-level-card h-100 {% if current_user.kyc_level == 0 %}active{% elif current_user.kyc_level > 0 %}completed{% endif %}">
                <div class="card-body text-center">
                    <div class="level-badge {% if current_user.kyc_level > 0 %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
                        {% if current_user.kyc_level > 0 %}<i class="fas fa-check"></i>{% else %}0{% endif %}
                    </div>
                    <h6 class="card-title">Level 0</h6>
                    <p class="text-muted mb-2">Unverified</p>
                    <hr>
                    <small>
                        <strong>Limit:</strong> $500/day<br>
                        <strong>Withdrawals:</strong> Disabled
                    </small>
                </div>
            </div>
        </div>

        <!-- Level 1 -->
        <div class="col-md-3 mb-3">
            <div class="card kyc-level-card h-100 {% if current_user.kyc_level == 1 %}active{% elif current_user.kyc_level > 1 %}completed{% endif %}">
                <div class="card-body text-center">
                    <div class="level-badge {% if current_user.kyc_level > 1 %}bg-success text-white{% elif current_user.kyc_level == 1 %}bg-primary text-white{% else %}bg-light{% endif %}">
                        {% if current_user.kyc_level > 1 %}<i class="fas fa-check"></i>{% else %}1{% endif %}
                    </div>
                    <h6 class="card-title">Level 1</h6>
                    <p class="text-muted mb-2">Basic</p>
                    <hr>
                    <small>
                        <strong>Required:</strong><br>
                        Email & Phone<br>
                        <strong>Limit:</strong> $2,000/day<br>
                        <strong>Withdrawals:</strong> $500/day
                    </small>
                </div>
            </div>
        </div>

        <!-- Level 2 -->
        <div class="col-md-3 mb-3">
            <div class="card kyc-level-card h-100 {% if current_user.kyc_level == 2 %}active{% elif current_user.kyc_level > 2 %}completed{% endif %}">
                <div class="card-body text-center">
                    <div class="level-badge {% if current_user.kyc_level > 2 %}bg-success text-white{% elif current_user.kyc_level == 2 %}bg-primary text-white{% else %}bg-light{% endif %}">
                        {% if current_user.kyc_level > 2 %}<i class="fas fa-check"></i>{% else %}2{% endif %}
                    </div>
                    <h6 class="card-title">Level 2</h6>
                    <p class="text-muted mb-2">Intermediate</p>
                    <hr>
                    <small>
                        <strong>Required:</strong><br>
                        ID Document<br>
                        <strong>Limit:</strong> $10,000/day<br>
                        <strong>Withdrawals:</strong> $3,000/day
                    </small>
                </div>
            </div>
        </div>

        <!-- Level 3 -->
        <div class="col-md-3 mb-3">
            <div class="card kyc-level-card h-100 {% if current_user.kyc_level == 3 %}active completed{% endif %}">
                <div class="card-body text-center">
                    <div class="level-badge {% if current_user.kyc_level == 3 %}bg-success text-white{% else %}bg-light{% endif %}">
                        {% if current_user.kyc_level == 3 %}<i class="fas fa-check"></i>{% else %}3{% endif %}
                    </div>
                    <h6 class="card-title">Level 3</h6>
                    <p class="text-muted mb-2">Advanced</p>
                    <hr>
                    <small>
                        <strong>Required:</strong><br>
                        Address Proof<br>
                        <strong>Limit:</strong> $50,000/day<br>
                        <strong>Withdrawals:</strong> $10,000/day
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Upload Form -->
    {% if current_user.kyc_level < 3 %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-upload"></i> Upload Verification Documents</h5>
        </div>
        <div class="card-body">
            <form id="kyc-form" enctype="multipart/form-data">
                <!-- Document Type -->
                <div class="mb-4">
                    <label class="form-label"><strong>Document Type</strong></label>
                    <select class="form-select" id="document_type" name="document_type" required>
                        <option value="">Select document type...</option>
                        <option value="NIN">National Identity Number (NIN)</option>
                        <option value="BVN">Bank Verification Number (BVN)</option>
                        <option value="passport">International Passport</option>
                        <option value="drivers_license">Driver's License</option>
                        <option value="utility_bill">Utility Bill (for Level 3)</option>
                    </select>
                </div>

                <!-- Document Number -->
                <div class="mb-4">
                    <label class="form-label"><strong>Document Number</strong></label>
                    <input type="text" class="form-control" id="document_number" name="document_number"
                           placeholder="Enter your document number" required>
                </div>

                <!-- Front Image -->
                <div class="mb-4">
                    <label class="form-label"><strong>Front of Document</strong></label>
                    <div class="upload-area" onclick="document.getElementById('front_image').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <p class="mb-0">Click to upload front of document</p>
                        <small class="text-muted">JPG, PNG or PDF (Max 5MB)</small>
                    </div>
                    <input type="file" id="front_image" name="front_image" accept="image/*,.pdf"
                           style="display: none;" required onchange="previewImage(this, 'front-preview')">
                    <img id="front-preview" class="document-preview" style="display: none;">
                </div>

                <!-- Back Image -->
                <div class="mb-4">
                    <label class="form-label"><strong>Back of Document</strong> <small class="text-muted">(if applicable)</small></label>
                    <div class="upload-area" onclick="document.getElementById('back_image').click()">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <p class="mb-0">Click to upload back of document</p>
                        <small class="text-muted">JPG, PNG or PDF (Max 5MB)</small>
                    </div>
                    <input type="file" id="back_image" name="back_image" accept="image/*,.pdf"
                           style="display: none;" onchange="previewImage(this, 'back-preview')">
                    <img id="back-preview" class="document-preview" style="display: none;">
                </div>

                <!-- Selfie -->
                <div class="mb-4">
                    <label class="form-label"><strong>Selfie with Document</strong></label>
                    <div class="upload-area" onclick="document.getElementById('selfie_image').click()">
                        <i class="fas fa-camera fa-3x text-primary mb-3"></i>
                        <p class="mb-0">Click to upload selfie holding your document</p>
                        <small class="text-muted">Clear photo showing your face and document</small>
                    </div>
                    <input type="file" id="selfie_image" name="selfie_image" accept="image/*"
                           style="display: none;" required onchange="previewImage(this, 'selfie-preview')">
                    <img id="selfie-preview" class="document-preview" style="display: none;">
                </div>

                <!-- Terms Agreement -->
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="terms_agree" required>
                    <label class="form-check-label" for="terms_agree">
                        I confirm that all information provided is accurate and the documents are authentic.
                        I understand that providing false information may result in account suspension.
                    </label>
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        <i class="fas fa-paper-plane"></i> Submit for Verification
                    </button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Submitted Documents -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-file-alt"></i> Your Submitted Documents</h5>
        </div>
        <div class="card-body">
            <div id="documents-list">
                <p class="text-center text-muted">Loading...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Load submitted documents
    loadDocuments();

    // Form submission
    $('#kyc-form').submit(function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        // Show loading
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Uploading...').prop('disabled', true);

        $.ajax({
            url: '/api/kyc/submit',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    alert('Documents submitted successfully! We will review them within 24-48 hours.');
                    $('#kyc-form')[0].reset();
                    $('.document-preview').hide();
                    loadDocuments();
                } else {
                    alert('Error: ' + response.error);
                }
                submitBtn.html(originalText).prop('disabled', false);
            },
            error: function(xhr) {
                alert('Failed to upload documents. Please try again.');
                submitBtn.html(originalText).prop('disabled', false);
            }
        });
    });
});

function previewImage(input, previewId) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            $('#' + previewId).attr('src', e.target.result).show();
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function loadDocuments() {
    $.get('/api/kyc/documents', function(data) {
        const container = $('#documents-list');
        container.empty();

        if (data.success && data.documents.length > 0) {
            data.documents.forEach(doc => {
                const statusBadge = doc.status === 'approved'
                    ? '<span class="badge bg-success">Approved</span>'
                    : doc.status === 'rejected'
                    ? '<span class="badge bg-danger">Rejected</span>'
                    : '<span class="badge bg-warning">Pending Review</span>';

                const card = `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-3">
                                    <strong>${doc.document_type}</strong><br>
                                    <small class="text-muted">${doc.document_number || 'N/A'}</small>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">Submitted:</small><br>
                                    ${new Date(doc.created_at).toLocaleDateString()}
                                </div>
                                <div class="col-md-3">
                                    ${statusBadge}
                                </div>
                                <div class="col-md-3 text-end">
                                    ${doc.status === 'rejected' && doc.rejection_reason
                                        ? '<button class="btn btn-sm btn-danger" onclick="showRejectionReason(\'' + doc.rejection_reason + '\')"><i class="fas fa-info-circle"></i> View Reason</button>'
                                        : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.append(card);
            });
        } else {
            container.html('<p class="text-center text-muted">No documents submitted yet.</p>');
        }
    });
}

function showRejectionReason(reason) {
    alert('Rejection Reason:\n\n' + reason);
}
</script>
{% endblock %}
